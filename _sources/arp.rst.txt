=============
Protocolo ARP
=============

Itroducción
-----------

Las direcciones de hosts dentro del protocolo IP no son compatibles con las direcciones Ethernet de 48 bits. El protocolo ARP, permite la distribución necesaria para construir tablas de traducción de una dirección IP a direcciones Ethernet de 48 bits, aunque fue diseñado originalmente para redes Ethernet, ha sido generalizado para permitir su uso en otros tipos de redes.

El problema
-----------

Ethernet permite el uso de varios protocolos por encima en un sólo cable, definido por el campo tipo en el encabezado Ethernet, sin embargo, Ethernet requiere de direcciones de 48 bits y los protocolos por encima difieren de este tamaño (IP tiene tamaño de 32 bits).

Un protocolo es necesario para distribuir dinámicamente la correspondencia entre el par protocolo-dirección y una dirección Ethernet.

Motivación
----------

A principios de los 80 (fecha del RFC-826), el uso de distintos protocolos de red era habitual, y Ethernet, estaba empezando a imponerse en el diseño de redes. Con este panorama, había dos alternativas, todo aquel que implemente un protocolo de red, diseñaba su propio método para la resolución de direcciones o se intentaba usar un estándar, para que su código pueda ser distribuido a otros sistemas sin necesidad de modificación.

El RFC-826 intenta establecer ese estándar.

Formato del paquete
-------------------

Es necesario el formato de un paquete que contenga el protocolo de resolución de dirección.

.. image:: _static/imagenes/cabecera-arp.png
    :align: center
    

- Tipo de hardware (HTYPE), especifica el protocolo de red, para Ethernet es 1
- Tipo de protocolo (PTYPE), para redes IPv4 es valor es 0x0800.
- Longitud hardware (HLEN), longitud en octetos de una dirección hardware, para Ethernet es 6.
- Longitud del protocolo (PLEN), para IPv4 es 4
- Código de operación (OPCODE), define si se trata de una pregunta (ARP-request, OPCODE = 1) o de una respuesta (ARP-reply, OPCODE = 2).
- Dirección hardware y dirección IP de origen y destino.

En teoría, los campos de longitud HLEN y PLEN, son redundantes, la longitud de una dirección de protocolo, debe estar determinada por el tipo de hardware y el tipo de protocolo. Esto es incluido para un chequeo de consistencia opcional y para monitorización y depuración de red

Generación del paquete
----------------------

El módulo ARP mantiene una cache de asociaciones entre direcciones hardware y direcciones de protocolo, la cache tiene un tamaño limitado, por lo que las entradas antiguas y menos frecuentes, son eliminadas por un recolector de basura. Las entradas marcadas como permanentes nunca serán eliminadas.

Para enviar datos a un destino, el emisor pregunta a su cache si existe esa asociación entre dirección hardware y dirección de protocolo, en caso negativo, se realizará una petición (ARP-request) a la dirección de broadcast, únicamente el host destino responderá con un ARP-reply al comparar la dirección contenida en el campo TARGET IP con su propia dirección IP. cuando se reciba una contestación, se añadirá una entrada arp no permanente en la cache.

Este formato del paquete, no permite que se haga mas de una resolución en el mismo paquete, una respuesta tiene la misma longitud que una solicitud, y varios de los campos son los mismos.

El código de operación, está para determinar si el paquete es una solicitud o una respuesta a una solicitud previa.

.. image:: _static/imagenes/arp-request.png
    :align: center
    
.. image:: _static/imagenes/arp-reply.png
    :align: center
    
Vulnerabilidad ARP
------------------

Es posible engañar a un host dentro de la red diciéndole que la dirección MAC con quien se quiere comunicar sea un tercer host, produciéndose así una redirección del tráfico del host origen al host destino, en donde toda la información que salga del host origen pase por un tercer host, y éste a su vez vuelva a redireccionar el tráfico hacia el host destino verdadero con el fin de funcionar transparentemente en la comunicación de ambos y observando todo lo que se dicen. Este tipo de ataque se conoce como “Hombre en medio” o **Man In The Middle**.

Una vez conseguimos **colocar** este tercer host entre dos hosts que se están comunicando, podremos monitorizar absolutamente todo el tráfico que circule entre origen y destino.

Ésto se lleva a cabo en la práctica enviando continuamente ARP-replys al host víctima, de esta manera, el host atacante conseguirá modificar la tabla ARP en caché del host victima introduciendo una entrada falsa, donde la dirección Ethernet del host destino, sea la del atacante.
